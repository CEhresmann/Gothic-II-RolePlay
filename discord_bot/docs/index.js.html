<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Discord bot for player authorization via Discord.
 * @author Timofey
 * @version 1.0.0
 */

require('dotenv').config();
const { Client, GatewayIntentBits, SlashCommandBuilder, REST, Routes } = require('discord.js');
const axios = require('axios');

const DISCORD_TOKEN = process.env.DISCORD_TOKEN;
const API_URL = process.env.API_URL || 'http://localhost:3000';
const API_KEY = process.env.API_KEY;

if (!DISCORD_TOKEN) {
    console.error('[BOT] DISCORD_TOKEN is not set in .env file');
    process.exit(1);
}

if (!API_KEY) {
    console.error('[BOT] API_KEY is not set in .env file');
    process.exit(1);
}

/**
 * The Discord client instance.
 * @type {Client}
 */
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages
    ]
});

/**
 * Slash command for authorization.
 * @type {SlashCommandBuilder}
 */
const authCommand = new SlashCommandBuilder()
    .setName('auth')
    .setDescription('Link your Discord account to your game account')
    .addStringOption(option =>
        option.setName('code')
            .setDescription('Authorization code from the game')
            .setRequired(true)
    );

const commands = [authCommand];

/**
 * Registers slash commands with Discord.
 * @async
 * @function registerCommands
 */
async function registerCommands() {
    try {
        const rest = new REST({ version: '10' }).setToken(DISCORD_TOKEN);
        
        console.log('[BOT] Registering slash commands...');
        
        // For quick testing, you can use Routes.applicationGuildCommands(clientId, guildId)
        const clientId = client.user.id;
        await rest.put(
            Routes.applicationCommands(clientId),
            { body: commands }
        );
        
        console.log('[BOT] Successfully registered slash commands');
    } catch (error) {
        console.error('[BOT] Error registering commands:', error);
    }
}

client.on('interactionCreate', async interaction => {
    if (!interaction.isChatInputCommand()) return;

    if (interaction.commandName === 'auth') {
        const code = interaction.options.getString('code');
        const discordId = interaction.user.id;

        await interaction.deferReply({ ephemeral: true });

        try {
            const verifyResponse = await axios.post(
                `${API_URL}/discord/verify`,
                { auth_code: code },
                {
                    headers: {
                        'x-api-key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    timeout: 5000
                }
            );

            if (!verifyResponse.data.valid) {
                let errorMessage = 'Invalid or expired authorization code.';
                
                if (verifyResponse.data.error === 'CODE_EXPIRED') {
                    errorMessage = 'The authorization code has expired. Please get a new one in the game.';
                } else if (verifyResponse.data.error === 'INVALID_CODE') {
                    errorMessage = 'Invalid authorization code. Please check your input.';
                }

                return await interaction.editReply({
                    content: `❌ ${errorMessage}`,
                    ephemeral: true
                });
            }

            const linkResponse = await axios.post(
                `${API_URL}/discord/link`,
                {
                    discord_id: discordId,
                    auth_code: code
                },
                {
                    headers: {
                        'x-api-key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    timeout: 5000
                }
            );

            if (!linkResponse.data.success) {
                let errorMessage = 'Error linking account.';
                
                if (linkResponse.data.error === 'DISCORD_ALREADY_LINKED') {
                    errorMessage = 'This Discord account is already linked to another game account.';
                } else if (linkResponse.data.error === 'CODE_EXPIRED') {
                    errorMessage = 'The authorization code has expired. Please get a new one in the game.';
                } else if (linkResponse.data.error === 'INVALID_CODE') {
                    errorMessage = 'Invalid authorization code.';
                }

                return await interaction.editReply({
                    content: `❌ ${errorMessage}`,
                    ephemeral: true
                });
            }

            console.log(`[BOT] Successfully linked Discord ${discordId} to player ${linkResponse.data.player_id}`);
            
            await interaction.editReply({
                content: `✅ **Success!** Your Discord account has been linked to your game account.\n\nYou can now close the authorization window in the game.`,
                ephemeral: true
            });

        } catch (error) {
            console.error('[BOT] Error processing auth command:', error);
            
            let errorMessage = 'An error occurred while verifying the code. Please try again later.';
            
            if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {
                errorMessage = 'Could not connect to the authorization server. Please contact an administrator.';
            } else if (error.response) {
                errorMessage = `Server error: ${error.response.data.message || error.response.statusText}`;
            }

            await interaction.editReply({
                content: `❌ ${errorMessage}`,
                ephemeral: true
            });
        }
    }
});

client.once('ready', async () => {
    console.log(`[BOT] Logged in as ${client.user.tag}`);
    console.log(`[BOT] Bot is ready!`);
    
    await registerCommands();
});

client.on('error', error => {
    console.error('[BOT] Discord client error:', error);
});

process.on('unhandledRejection', error => {
    console.error('[BOT] Unhandled promise rejection:', error);
});

client.login(DISCORD_TOKEN).catch(error => {
    console.error('[BOT] Failed to login:', error);
    process.exit(1);
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#authCommand">authCommand</a></li><li><a href="global.html#client">client</a></li><li><a href="global.html#registerCommands">registerCommands</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Jan 02 2026 00:48:17 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
